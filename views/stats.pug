extends head 
block head
    title Pesquisa
    script(src="https://cdn.jsdelivr.net/npm/chart.js")

block content
    header.p-2.container
        form.row.align-items-baseline
            h1.col-12.col-md-4 Jurisprudência
            .col-12.col-md-8.no-print
                .input-group
                    input.form-control(type="search", name="q", placeholder="Pesquisar...", value=q)
                    .input-group-append
                        button.btn.btn-primary(type="submit"): i.bi-search
            .col-12.col-md-8.only-print
                p Estatísticas da pesquisa: !{q}
    main.container
        if error 
            pre.alert.alert-danger: code !{error.stack}
        else
            .row
                .col-12.col-md-3.no-print
                    .row.p-2
                        form(method="post").col-12
                            input(type="search", name="q", value=q, hidden)
                            details(open=!!open)
                                summary.d-block
                                    h4.d-inline
                                        i.bi-funnel 
                                        | Filtrar 
                                        small: i.bi-minimizemaximize
                                .d-flex.flex-column.my-2
                                    -let tribunais = []
                                    h5 Tribunal
                                    -let key = "Tribunal"
                                    for bucket in aggs[key].buckets
                                        -let checked = filters[key] && filters[key].indexOf(bucket.key) > -1
                                        if checked
                                            -tribunais.push(bucket.key)
                                        .form-check.form-check-inline(data-tribunal=bucket.key)
                                            input.form-check-input(type="checkbox", name=key, value=bucket.key, checked=checked, id=bucket.key.replace(/\s/g, ""), hidden)
                                            label.form-check-label(for=bucket.key.replace(/\s/g, "")).d-flex.justify-content-between.align-items-center.w-100
                                                span.d-block !{bucket.key} 
                                                span.d-block (!{bucket.doc_count})
                                .d-flex.flex-column.my-2
                                    h5 Relator
                                    +await(`/datalist?id=relatores&agg=Relator&tribunais=${tribunais.join(",")}&q=${q || ""}`)
                                    //datalist#relatores
                                        for bucket in aggs["Relator"].buckets
                                            option= bucket.key
                                    input.form-control(type="text", name="Relator", autocomplete="off", list="relatores", placeholder="Filtrar relator...")
                                    if "Relator" in filters
                                        for f in filters["Relator"]
                                            .form-check.form-check-inline(style="--tribunal-color: #0f0")
                                                input.form-check-input(type="checkbox", name="Relator", value=f, checked, id=f.replace(/\s/g, ""), hidden)
                                                label.form-check-label(for=f.replace(/\s/g, "")).d-flex.justify-content-between.align-items-center.w-100
                                                    span.d-block !{f} 
                                                    i.d-blocl.bi-trash
                                .d-flex.flex-column.my-2
                                    h5 Descritor
                                    +await(`/datalist?id=descritores&agg=Descritores&tribunais=${tribunais.join(",")}&q=${q || ""}`)
                                    //datalist#descritores
                                        for bucket in aggs["Descritores"].buckets
                                            option= bucket.key
                                    input.form-control(type="text", name="Descritores", autocomplete="off", list="descritores", placeholder="Filtrar descritores...")
                                    if "Descritores" in filters
                                        for f in filters["Descritores"]
                                            .form-check.form-check-inline(style="--tribunal-color: #0f0")
                                                input.form-check-input(type="checkbox", name="Descritores", value=f, checked, id=f.replace(/\s/g, ""), hidden)
                                                label.form-check-label(for=f.replace(/\s/g, "")).d-flex.justify-content-between.align-items-center.w-100
                                                    span.d-block !{f} 
                                                    i.d-blocl.bi-trash
                                .d-flex.flex-column.my-2
                                    h5 Data
                                    .input-group
                                        .input-group-prepend.w-25
                                            label(for="data_inicio").input-group-text.w-100 De
                                        input.form-control(type="number", name="MinAnos", min="1900", max=new Date().getFullYear(), value=filters["MinAnos"], step="1")#data_inicio
                                    .input-group
                                        .input-group-prepend.w-25
                                            label(for="data_fim").input-group-text.w-100 Até
                                        input.form-control(type="number", name="MaxAnos", min="1900", max=new Date().getFullYear(), value=filters["MaxAnos"], step="1")#data_fim
                                .d-flex.flex-row.my-2.justify-content-between.align-items-center
                                    button.btn.btn-primary(type="submit") Aplicar
                                    a.btn.btn-danger(href=`?q=${q || ""}`) Limpar
                                .d-flex.flex-row.my-2.justify-content-center.align-items-center
                                    button.btn.btn-primary(type="submit", formaction="..") Ver resultados

                            
                            // Not used 
                            mixin filter(agg, key)
                                details 
                                    summary !{key}
                                    ul.list-group.list-group-flush
                                        for bucket in agg.buckets
                                            li.list-group-item
                                                label.form-check-label.w-100.d-flex.justify-content-between.align-items-center
                                                    input.form-check-input(type="checkbox", name=key, value=bucket.key, checked=filters[key] && filters[key].indexOf(bucket.key) > -1)
                                                    | !{bucket.key}
                                                    span.badge.badge-primary.badge-pill 
                                                        | !{bucket.doc_count}
                            //+filter(aggs["Tribunal"], "Tribunal")
                            //+filter(aggs["Relator"], "Relator")
                            //+filter(aggs["Descritores"], "Descritores")
                                
                                
                                    

                .col-12.col-md-9.print-main
                    .row.p-2
                        .col-12: h4 Acordãos por tribunal e ano
                    .p-relative(style="height: 70vh; width: 100%")
                        canvas#graph
                        script.
                            function strRange(min, max) {
                                let r = []
                                for (let i = min; i <= max; i++) {
                                    r.push(`${i}`)
                                }
                                return r
                            }
                            let maxYear = !{parseInt(aggs.MaxAno.value_as_string)}
                            let minYear = !{parseInt(aggs.MinAno.value_as_string)}
                            let buckets = !{JSON.stringify(aggs.Anos.buckets)}
                            let labels = strRange(minYear,maxYear);
                            function tribColor(trib){
                                return {
                                    "Supremo Tribunal Administrativo": "#003f5c",
                                    "Supremo Tribunal de Justiça": "#2f4b7c",
                                    "Tribunal da Relação do Porto": "#665191",
                                    "Tribunal da Relação de Lisboa": "#a05195",
                                    "Tribunal Constitucional": "#d45087",
                                    "Tribunal Central Administrativo Sul": "#f95d6a", 
                                    "Tribunal Central Administrativo Norte": "#f95d6a",
                                    "Tribunal da Relação de Coimbra": "#ff7c43",
                                    "Tribunal da Relação de Évora": "#ffa600",
                                    "Tribunal da Relação de Guimarães": "#febf01",
                                    "Tribunal dos Conflitos": "#fecb02"
                                }[trib] || "#000"
                            }
                            new Chart(document.getElementById("graph"), {
                                type: "bar",
                                data: {
                                    labels: labels,
                                    datasets: buckets.map(trib => ({
                                        label: trib.key,
                                        borderWidth: 1,
                                        data: trib.Anos.buckets.map(ano => ({x: ano.key_as_string, y: ano.doc_count})).sort((a, b) => a.x - b.x),
                                        backgroundColor: tribColor(trib.key)
                                    }))
                                },
                                options: {
                                    title: {
                                        display: true,
                                        text: 'Acórdãos por ano e tribunal'
                                    },
                                    legend: {
                                        display: true
                                    },
                                    scales: {
                                        x: {
                                            stacked: true
                                        },
                                        y: {
                                            stacked: true
                                        }
                                    },
                                    maintainAspectRatio: false
                                }
                            });
    style.
        @media print{
            .no-print{
                display: none;
            }

            .print-main{
                max-width: 100% !important;
                width: 100% !important;
                flex: 100%;
            }

            .only-print{
                display: block !important;
            }
        }
        .only-print{
            display: none;
        }

        details[open] .bi-minimizemaximize::before{
            content: "\F14B";
        }
        details .bi-minimizemaximize::before{
            content: "\F14C";
        }

        input[type=checkbox] ~ label{
            position: relative;
            cursor: pointer;
        }
        input[type=checkbox] ~ label:before{
            content: "";
            position: absolute;
            top: 5px;
            bottom: 5px;
            left: -10px;
            width: 0px;
            background-color: var(--tribunal-color);
            border-radius: 10px;
            transition: 0.2s;
        }
        input[type=checkbox]:checked ~ label:before{
            width: 5px;
        }

        .graph-column{
            position: relative;
            background-color: #f00;
            border-radius: 10px;
            transition: 0.2s;
        }